name: Testing

on:
  push:
    tags:
    - '**'
  workflow_dispatch:

env:
  CHANGELOG_FILE: ${{ github.workspace }}-CHANGES.md
  STAGING_DIR: ${{ github.workspace }}-staging


jobs:
  tagpush:
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    runs-on: windows-latest
    
    steps:
      - name: ref test for prerelease
        if: ${{ contains(github.ref_name, '-') }}
        run: echo ${{github.ref_name}}
      
      - name: test for tag
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: echo ${{github.ref_name}}
  
  dispatch:
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3  
    
    - name: echo github.ref_name
      run: echo ${{github.ref_name}}
    - name: echo github.ref
      run: echo ${{github.ref}}
  
    # tag this commit
    - run: echo "VERSION=0.2.1-nightly" >> $env:GITHUB_ENV
    - name: Create Tag
      id: tag_version
      uses: rfuzzo/github-tag-action@7b0316b3fb8aa236fdc20bee0614ea6ef99f4bf1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        default_bump: false
        custom_tag: ${{ env.VERSION }}
        tag_prefix: ""
        dry_run: true
        append_to_pre_release_tag: ""
    
    # echo
    - name: output
      run: |
        echo new_tag: ${{ steps.tag_version.outputs.new_tag }}
        echo new_version: ${{ steps.tag_version.outputs.new_version }}
        echo previous_tag: ${{ steps.tag_version.outputs.previous_tag }}
        echo previous_version: ${{ steps.tag_version.outputs.previous_version }}
        echo release_type: ${{ steps.tag_version.outputs.release_type }}

    # echo
    - name: changelog
      run: |
        echo "This is a beta release so you may encounter bugs. Please report them. \n ${{ steps.tag_version.outputs.changelog }}"
    
    # - name: Install git-cliff
    #   uses: baptiste0928/cargo-install@v1
    #   with:
    #     crate: git-cliff
    #     version: "0.9"

    # - name: Run git-cliff
    #   run: git-cliff
    # - run: git-cliff -o CHANGELOG.md
    # - run: Get-Content -Path .\CHANGELOG.md -TotalCount 10
    
    - name: set tag env to github.ref
      run: echo "TAG=${{github.ref}}" >> $env:GITHUB_ENV
    - name: change tag
      if: ${{ !startsWith(github.ref, 'refs/tags/') }}
      run: echo "TAG=testing" >> $env:GITHUB_ENV
    
    
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        draft: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
